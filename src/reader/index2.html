<!DOCTYPE html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimal-ui">
        <link rel="stylesheet" href="./css/main.css">
        <link rel="stylesheet" href="./css/bootstrap.min.css">
        <script src="./js/jquery.min.js"></script>
        <script>
        if(typeof module==='object')
        {
            window.jQuery = window.$ = module.exports; //ç”¨äºelectronå®¢æˆ·ç«¯
        }
        </script>
        <script src="./js/zip.min.js"></script>
        <script src="./js/epub.js"></script>
        <script src="./js/reader.min.js"></script>
        <script src="./js/bootstrap.min.js"></script>
        
    </head>
    <body>
		<div id="sidebar">
            <div id="tocView"></div>
		</div>
		<div id="main">
			<div id="titlebar">
                <div id="opener">
                    <a id="slider" class="icon-menu" style='border-radius:25px;cursor:pointer;color:#5bc0de;width:50px;height:25px;'>ç›®å½•</a>
                </div>
                <div id="metainfo">
                    <span id="book-title"></span>
                    <span id="title-seperator">&nbsp;&nbsp;â€“&nbsp;&nbsp;</span>
                    <span id="chapter-title"></span>
                    <div id="failedMark" class="alert alert-info" role="alert">æ ‡è®°å¤±è´¥ï¼ŒåŸå› ï¼šæ‰€ç‚¹å‡»çš„å¥å­ä¸æ”¯æŒå¿«é€Ÿæ ‡è®°ã€‚</div>
                    <div id="failedMarkSelect" class="alert alert-info" role="alert">æ ‡è®°å¤±è´¥ï¼ŒåŸå› ï¼šæœªé€‰æ‹©æ ‡ç­¾æˆ–æ‰€é€‰å†…å®¹ä¸åœ¨æ­£æ–‡ä¸­ã€‚</div>
                    <div id="successedMark" class="alert alert-success" role="alert">æ ‡è®°æˆåŠŸï¼Œå¯åœ¨ä¸»é¡µæ ‡è®°ç•Œé¢æŸ¥çœ‹åˆ†ç±»ã€ç»Ÿè®¡ã€ç´¢å¼•ç­‰ä¿¡æ¯ã€‚</div>
                </div>
			</div>
			<div id="divider"></div>
			<div id="prev" class="arrow" >â€¹</div>
			<div id="viewer"></div>
			<div id="next" class="arrow" >â€º</div>
            <div id="loader"><img src="./image/loader.gif"></div>
            <div id='bottombar' style='text-align:center'>
                <div class="progress" >
                    <div id='rate' class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%;background-color:#5bc0de;z-index:-1;">
                    </div>
                </div>
                <button type="button" id='username' class="label label-info" data-toggle="tooltip" data-placement="top" title="çŠ¶æ€ï¼šé˜…è¯»ä¸­~æ­£åœ¨äº§ç”Ÿé˜…è¯»æ•°æ®"><span class="glyphicon glyphicon-user"></span> </button>
                <span id="tagBottomItem"></span>
                <button type="button" class="label label-info" id='shareMarks' data-toggle="tooltip" data-placement="top" title="å¼€å…³ï¼šæ˜¯å¦é˜…è§ˆå…¶ä»–è¯»è€…çš„æ‰¹æ³¨"><span class="glyphicon glyphicon-eye-open"></span></button>  
                <button type="button" class="label label-info" id='markingMode' data-toggle="tooltip" data-placement="top" title="æ¨¡å¼ï¼šæ˜¯å¦æ‰“å¼€å¿«é€Ÿæ ‡è®°æ¨¡å¼"><span class="glyphicon glyphicon-lock"></span></button>        
                <button type="button" class="label label-info" id='help' data-toggle="tooltip" data-placement="top" title="å¸®åŠ©"><span class="glyphicon glyphicon-question-sign"></span></button>                    
            </div>    
        </div>
        <div class="modal fade bs-example-modal-lg" id='helpModal' tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content" style="text-indent:'20px';margin: 20px 20px 20px 20px;">
                    <h2 id='helpUsername' style="text-align:center"></h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
                    <hr/>
                    <h4>&emsp;æ™®é€šæ ‡è®°</h4>
                        <p>&emsp;&emsp;&emsp;é€‰ä¸­ä¸€æ®µæ­£æ–‡æ–‡æœ¬ï¼Œå¼¹å‡ºæ‚¬æµ®çª—ï¼Œä¸ºæ–‡æœ¬è®¾ç½®ä¸€ä¸ªç‰¹æ®Šæ ‡ç­¾æˆ–è‡ªå®šä¹‰æ ‡ç­¾ï¼Œå¹¶ä½œå¯é€‰çš„æ‰¹æ³¨ã€‚</p>
                    <h4>&emsp;å¿«é€Ÿæ ‡è®°</h4>
                        <p>&emsp;&emsp;&emsp;ç‚¹å‡»ä¸‹æ–¹ <span class="label label-info" ><span class="glyphicon glyphicon-lock"></span></span> æŒ‰é’®åˆ‡æ¢åˆ°å¿«é€Ÿæ ‡è®°æ¨¡å¼ï¼Œå¹¶åœ¨ä¸‹æ–¹æ ‡ç­¾ç»„ä¸­é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ ‡ç­¾ï¼Œç„¶ååœ¨æ­£æ–‡ä¸­è¿ç»­ç‚¹å‡»ä»»æ„å¥å­ï¼ŒæˆåŠŸæ ‡è®°ã€‚</p>
                    <hr/>
                    <h4>&emsp;ç‰¹æ®Šæ ‡ç­¾</h4>
                        <p>&emsp;&emsp;&emsp;æ ‡è®°ä¸º <span class="label label-primary" style="cursor:pointer;background-color:#777">æŠ˜å </span> çš„æ–‡æœ¬ï¼Œä¸‹æ¬¡é˜…è¯»æ—¶å°†ä¸å†å±•ç¤ºã€‚</p>
                        <p>&emsp;&emsp;&emsp;æ ‡è®°ä¸º <span class="label label-primary" style="cursor:pointer;background-color:#5bc0de">æ”¶è—</span> çš„æ–‡æœ¬ï¼Œå°†å­˜è‡³ç§æœ‰çš„æ”¶è—å¤¹ã€‚</p>
                        <p>&emsp;&emsp;&emsp;æ ‡è®°ä¸º <span class="label label-primary" style="cursor:pointer;background-color:#d9534f">é‡è¦</span> çš„æ–‡æœ¬ï¼Œå°†çªå‡ºæ˜¾ç¤ºå¹¶é‡ç‚¹æ ‡è®°ã€‚</p>
                        <p>&emsp;&emsp;&emsp;æ ‡è®°ä¸º <span class="label label-primary" style="cursor:pointer;background-color:#18c9aa">åˆ†äº«</span> çš„æ–‡æœ¬ï¼Œå°†è¢«æ¨èç»™ä¹¦å‹é˜…è¯»ã€‚</p>
                    <h4>&emsp;è‡ªå®šä¹‰æ ‡ç­¾</h4>
                        <p>&emsp;&emsp;&emsp;åœ¨æ™®é€šæ ‡è®°æ¨¡å¼ä¸‹ï¼Œé€‰ä¸­æ–‡æœ¬å¼¹å‡ºæ‚¬æµ®çª—ã€‚</p>
                        <p>&emsp;&emsp;&emsp;ç‚¹å‡» <span class="label label-success"><span class="glyphicon glyphicon-plus"></span></span> å®šä¹‰ç§æœ‰çš„æ ‡ç­¾ã€‚</p>
                        <p>&emsp;&emsp;&emsp;ç‚¹å‡» <span class="label label-success"><span class="glyphicon glyphicon-minus"></span></span> åˆ é™¤æ ‡ç­¾ï¼Œä½†åº”è‡³å°‘ä¿ç•™ä¸¤ä¸ªæ ‡ç­¾ã€‚</p>
                    <hr/>
                    <h4>&emsp;å¿«æ·æ“ä½œ</h4>
                        <p>&emsp;&emsp;&emsp;Shift+æ»šè½®/é”®ç›˜â†‘æˆ–â†“ï¼š æ”¾å¤§æˆ–ç¼©å°æ­£æ–‡å­—å·ï¼ˆæ–‡æœ¬è¿‡å¤§ï¼Œä¼šå¯¼è‡´å†…å®¹æ˜¾ç¤ºä¸å…¨ï¼Œé…Œæƒ…ä½¿ç”¨ï¼‰ã€‚</p>
                        <p>&emsp;&emsp;&emsp;æ»šè½®/é”®ç›˜â†æˆ–â†’ï¼š å‘å·¦æˆ–å‘å³ç¿»é¡µã€‚</p>
                                          
                </div>
            </div>
        </div>
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-body">
                      <form>
                        <div class="form-group">
                            <hr><p id='commentParagraph'></p><hr>
                        </div>
                        <div class="form-group" id='tagFrame'>
                                <div id='tags'></div>
                                <span class="label label-success" style="cursor:pointer" id='addTag'><span class="glyphicon glyphicon-plus"></span></span>
                                <span class="label label-success" style="cursor:pointer" id='removeTag'><span class="glyphicon glyphicon-minus"></span></span>
                                <input type="text" class="form-control" placeholder="è¾“å…¥æ ‡ç­¾å..." id="tagNameInput" style='font-size:0.8em;width:100px;height:18px;display:inline-block'/>                                
                                <input type="color" name="color" id="color" style="border-radius:3px;height:18px;position:relative;bottom:1px;"/>                                                                          
                                <span class="label label-success" style="cursor:pointer" id="submitAddTag">æ·»åŠ æ ‡ç­¾</span> 
                                <span class="label label-default" style="cursor:pointer" id="closeAddTag">å–æ¶ˆæ·»åŠ </span>
                                <span class="label label-default" style="cursor:pointer" id="closeRemove">å–æ¶ˆåˆ é™¤</span>
                        </div>
                        <div class="form-group">                   
                          <textarea class="form-control" id="message-text" style="resize:none;"></textarea>
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default" data-dismiss="modal">å…³é—­</button>
                      <button type="button" class="btn btn-primary" id='commentFinish'>å®Œæˆæ‰¹æ³¨</button>
                    </div>
                  </div>
                </div>
            </div>
		<script>
			EPUBJS.cssPath = "./css/";
			var urlinfo = (window.location.href);
			var len=urlinfo.length;//è·å–urlçš„é•¿åº¦
			var offset=urlinfo.indexOf("?");//è®¾ç½®å‚æ•°å­—ç¬¦ä¸²å¼€å§‹çš„ä½ç½®
			if(offset==-1)
			{   
				alert('éæ³•è®¿é—®ï¼');
				window.close();
			}
			else
				var newsidinfo=urlinfo.substr(offset,len)//å–å‡ºå‚æ•°å­—ç¬¦ä¸² è¿™é‡Œä¼šè·å¾—ç±»ä¼¼â€œid=1â€è¿™æ ·çš„å­—ç¬¦ä¸²
			if(newsidinfo.indexOf('&')>=0)
			{
				var newsids=newsidinfo.split("&");//å¯¹è·å¾—çš„å‚æ•°å­—ç¬¦ä¸²æŒ‰ç…§â€œ=â€è¿›è¡Œåˆ†å‰²
				var bookname=newsids[0].split('=')[1];//å¾—åˆ°å‚æ•°å€¼
                var username=decodeURIComponent(newsids[1].split('=')[1]);
                var cfi=newsids[2].split('=')[1];
                var key=newsids[3].split('=')[1].split('#')[0];
                fetch('/getLoginKey', { 
                    method: 'post', 
                    headers: { 
                    "Content-type": "application/x-www-form-urlencoded" 
                    }, 
                    body: "username="+username //ç”¨æˆ·å
                }).then(
                    response => response.json()
                ).then((keycheck)=>{
                    if(keycheck.keycheck==key)
                    {
                        let date = new Date();
                        if(date.getHours()>=12 && date.getHours()<=18)
                            $('#helpUsername').text(' ä¸‹åˆå¥½ï¼Œ'+username+'ï¼')
                        if(date.getHours()>=18 && date.getHours()<=24)
                            $('#helpUsername').text(' æ™šä¸Šå¥½ï¼Œ'+username+'ï¼')
                        if(date.getHours()>=6 && date.getHours()<=12)
                            $('#helpUsername').text(' ä¸Šåˆå¥½ï¼Œ'+username+'ï¼')
                        if(date.getHours()>=0 && date.getHours()<=6)
                            $('#helpUsername').text(' ç¡å§ï¼Œ'+username+'ï¼')
                        $('#helpModal').modal('show');
                    }
                    else
                    {
                        alert('éæ³•è®¿é—®');
				        window.close();
                    }
                }).catch(function(e) {
                    console.log(e);
                });
			}
			else
			{
				alert('éæ³•è®¿é—®');
				window.close();
			}
            $('#username').html($('#username').html()+username);
            $('#username').hover(function(){
                $('#username').tooltip('show');
            })
            var reader = ePubReader("./book/"+bookname);
            window.onbeforeunload = function(e){
                e.returnValue = 'ç¡®å®šç¦»å¼€é˜…è¯»å™¨å—ï¼Ÿæ•°æ®å·²ä¸Šä¼ è‡³æœåŠ¡å™¨'
            }
            var topic = 0;
            reader.book.getToc().then((toc)=>{
                topic = toc;
                if(cfi.length>=7) //æŒ‡å®šcfiçš„æƒ…å†µ
                {
                    var compareCFI = cfi.split('!')[0]+')';
                    for(var t=0;t<topic.length;t++)
                    {
                        if(compareCFI == topic[t].cfi)
                        {
                            reader.book.displayChapter(topic[t].cfi);
                        }
                    }
                }
            });

            var shareMarks = true;
            var markingMode = true;
            var tags = [];
            var tagsForRemove =[];
            var currentTag = '';
            var currentColor = '';
            var fontSize = 1;
            var selected='';
            $('#failedMark').hide();
            $('#successedMark').hide();
            $('#failedMarkSelect').hide();
            $('#shareMarks').hover(function(){
                $('#shareMarks').tooltip('show');
            });
            $('#help').hover(function(){
                $('#help').tooltip('show');
            });
            $('#help').click(function(){
                $('#helpModal').modal('show');
            });
            $('#markingMode').hover(function(){
                $('#markingMode').tooltip('show');
                fetch('/getUserTags', { 
                    method: 'post', 
                    headers: { 
                    "Content-type": "application/x-www-form-urlencoded" 
                    }, 
                    body: "username="+username //ç”¨æˆ·å
                }).then(
                    response => response.json()
                ).then((user)=>{
                    tags = user[0].tags.split(',').slice(0,-1);
                }).catch(function(e) {
                    console.log(e);
                });
            })

            $('#markingMode').click(()=>{
                if(markingMode)
                {
                    markingMode = false;
                    currentTag = '';
                    for(var tagItem=0;tagItem<tags.length;tagItem++)
                    {
                        if(tags[tagItem].split('#')[0]!='åˆ†äº«')
                            $('#tagBottomItem').append(`
                                <button 
                                    class="label label-primary" 
                                    onclick="let nodes = this.parentNode.childNodes;
                                            for(node in nodes)
                                            {
                                                if(nodes[node].nodeType==1)
                                                    nodes[node].style.border='';
                                            }
                                            this.style.border='4px solid #${tags[tagItem].split('#')[1]}';
                                            sentenceMark('${tags[tagItem].split('#')[0]}','#'+'${tags[tagItem].split('#')[1]}');" 
                                    style="cursor:pointer;background-color:#${tags[tagItem].split('#')[1]}" 
                                >
                                    ${tags[tagItem].split('#')[0]}
                                </button> 
                            `);
                    }
                    
                    var compareCFI = 'epubcfi('+reader.book.currentChapter.cfiBase+')';
                    for(var t1=0;t1<topic.length;t1++)
                    {
                        if(compareCFI == topic[t1].cfi)
                        {
                            reader.book.displayChapter(topic[t1].cfi);
                        }
                    }
                }
                else
                {
                    markingMode = true;
                    $('#tagBottomItem').children().remove();
                    var compareCFI = 'epubcfi('+reader.book.currentChapter.cfiBase+')';
                    for(var t2=0;t2<topic.length;t2++)
                    {
                        if(compareCFI == topic[t2].cfi)
                        {
                            reader.book.displayChapter(topic[t2].cfi);
                        }
                    }
                }
            })

            $('#shareMarks').click(()=>{
                    if(shareMarks == false)
                    {
                        shareMarks = true;
                        $('#shareMarks').html('<span class="glyphicon glyphicon-eye-open"></span>');
                        var url = window.location.href.split('#')[1];
                        var compareCFI = url.split('!')[0]+')';
                        for(var t=0;t<topic.length;t++)
                        {
                            if(compareCFI == topic[t].cfi)
                            {
                                reader.book.displayChapter(topic[t].cfi);
                            }
                        }
                    }
                    else
                    {
                        shareMarks = false;
                        $('#shareMarks').html('<span class="glyphicon glyphicon-eye-close"></span>');
                        var url = window.location.href.split('#')[1];
                        var compareCFI = url.split('!')[0]+')';
                        for(var t=0;t<topic.length;t++)
                        {
                            if(compareCFI == topic[t].cfi)
                            {
                                reader.book.displayChapter(topic[t].cfi);
                            }
                        }
                    }
            })

            function Colorful(span,spanEnd,color){
                while(span!=spanEnd){ //é€‰ä¸­åŒºåŸŸé¦–å°¾ä¸åŒæ—¶è¿›è¡ŒæŸ“è‰²ï¼Œé¦–éƒ¨æŒ‡é’ˆç§»åŠ¨åˆ°å°¾éƒ¨ç»“æŸæŸ“è‰²
                    try{
                        if(span.innerText!='')
                        {
                            span.style.color = color;
                            if(span.nextElementSibling!=null)
                            {
                                span = span.nextElementSibling;//è·¨SPANæ ‡ç­¾çš„æƒ…å†µ
                            }
                            else
                            {   
                                if(span.parentNode.nextElementSibling.innerText!='')
                                    span = span.parentNode.nextElementSibling.firstChild;//è·¨Pæ ‡ç­¾çš„æƒ…å†µ
                                else
                                    span = span.parentNode.nextElementSibling;
                            }
                        }
                        else
                        {
                            span = span.nextElementSibling.firstChild;//æŸäº›epubä¹¦ä¸­å«æœ‰<p></p>ç©ºæ ‡ç­¾ï¼Œè·³è¿‡è¿™äº›ç©ºæ®µ
                        }
                    }
                    catch(err)
                    {
                        span = span.parentNode;
                    }
                    
                }
                span.style.color = color;//å°¾éƒ¨æŸ“è‰²
                return span;
            }

            function starMark(span,spanEnd,flag){
                if(flag=='1')
                {
                    while(span!=spanEnd){ 
                        try{
                            if(span.innerText!='')
                            {
                                span.style.borderBottom='2px black solid';
                                span.style.paddingBottom='1px';
                                if(span.nextElementSibling!=null)
                                {
                                    span = span.nextElementSibling;//è·¨SPANæ ‡ç­¾çš„æƒ…å†µ
                                }
                                else
                                {   
                                    if(span.parentNode.nextElementSibling.innerText!='')
                                        span = span.parentNode.nextElementSibling.firstChild;//è·¨Pæ ‡ç­¾çš„æƒ…å†µ
                                    else
                                        span = span.parentNode.nextElementSibling;
                                }
                            }
                            else
                            {
                                span = span.nextElementSibling.firstChild;//æŸäº›epubä¹¦ä¸­å«æœ‰<p></p>ç©ºæ ‡ç­¾ï¼Œè·³è¿‡è¿™äº›ç©ºæ®µ
                            }
                        }
                        catch(err)
                        {
                            span = span.parentNode;
                        }
                    }
                    span.style.borderBottom='2px black solid';
                    span.style.paddingBottom='1px';
                }
                else
                {
                    while(span!=spanEnd){ 
                        try{
                            if(span.innerText!='')
                            {
                                span.style.borderBottom='none';
                                if(span.nextElementSibling!=null)
                                {
                                    span = span.nextElementSibling;//è·¨SPANæ ‡ç­¾çš„æƒ…å†µ
                                }
                                else
                                {   
                                    if(span.parentNode.nextElementSibling.innerText!='')
                                        span = span.parentNode.nextElementSibling.firstChild;//è·¨Pæ ‡ç­¾çš„æƒ…å†µ
                                    else
                                        span = span.parentNode.nextElementSibling;
                                }
                            }
                            else
                            {
                                span = span.nextElementSibling.firstChild;//æŸäº›epubä¹¦ä¸­å«æœ‰<p></p>ç©ºæ ‡ç­¾ï¼Œè·³è¿‡è¿™äº›ç©ºæ®µ
                            }
                        }
                        catch(err)
                        {
                            span = span.parentNode;
                        }
                    }
                    span.style.borderBottom='none';
                }
                
            }

            function clickMark(comment,data,span,spanEnd){
                comment.onclick=function(){
                    if(comment.getAttribute('state')=='1')
                    {
                        comment.setAttribute('title','éšè—æ ‡è®°');
                        comment.setAttribute('state','0');
                        comment.style.color = 'white';
                        starMark(span,spanEnd,'1');
                        if(data.comment=='')
                        {
                            comment.innerHTML='"'+data.username+'"çš„æ ‡è®°'+'<span style="color:red;">(ğŸ‘ '+data.likes+')</span>';
                        }
                        else
                        {
                            comment.innerHTML='"'+data.username+'"çš„æ‰¹æ³¨ï¼š'+data.comment.replace(/[\r\n]/g,"")+'<span style="color:red;">(ğŸ‘ '+data.likes+')</span>';
                        }
                        
                    }
                    else
                    {
                        comment.setAttribute('title','æŸ¥çœ‹æ ‡è®°');
                        comment.setAttribute('state','1');
                        starMark(span,spanEnd,'0');
                        if(data.comment.length>10)
                            comment.innerHTML='"'+data.username+'"çš„æ‰¹æ³¨ï¼š'+data.comment.substr(0,10).replace(/[\r\n]/g,"")+'...å‰©ä½™'+(data.comment.length-10)+'å­—'+'<span style="color:red;">(ğŸ‘ '+data.likes+')</span>';
                        else
                        {
                            if(data.comment=='')
                            {
                                comment.innerHTML='"'+data.username+'"çš„æ ‡è®°'+'<span style="color:red;">(ğŸ‘ '+data.likes+')</span>';
                            }
                            else
                            {
                                comment.innerHTML='"'+data.username+'"çš„æ‰¹æ³¨ï¼š'+data.comment.substr(0,10).replace(/[\r\n]/g,"")+'<span style="color:red;">(ğŸ‘ '+data.likes+')</span>';
                            }
                        }
                    }
                }
            }

            function clickMarkSelf(comment,data,span,spanEnd){
                comment.onclick=function(){
                    if(comment.getAttribute('state')=='1')
                    {
                        comment.setAttribute('state','0');
                        comment.style.color = 'white';
                        starMark(span,spanEnd,'1');
                    }
                    else
                    {
                        comment.setAttribute('state','1');
                        starMark(span,spanEnd,'0');
                    }
                }
            }

            function sentenceMark(a,b){
                currentTag = a;
                currentColor = b;
            };

            function getCFI(end) {   //å¥å­æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»ä»»æ„å­—ï¼Œæ ‡è®°è¯¥å¥å­ï¼Œå¹¶ç”Ÿæˆå¯ä¸æ™®é€šæ¨¡å¼å…¼å®¹çš„CFIä½ç½®ã€‚
                if (currentColor != '' && currentTag != '')//coloré˜²æ­¢é‡å¤æ ‡è®°ï¼Œcurrenté˜²æ­¢æ²¡æœ‰æ ‡ç­¾å’Œé¢œè‰²
                {
                    let first = end;
                    let t = end;
                    let count = 0;
                    while (t != null && t.innerText != "ã€‚" && t != '') { //å‘å‰é¢éå†åˆ°å¥å·
                        count++;
                        t.style.color = currentColor;
                        first = t;
                        t = t.previousElementSibling;
                    }
                    reader.book.renderer.render.window.getSelection().selectAllChildren(first);
                    let selectedSentence = reader.book.renderer.render.window.getSelection();
                    while (count--) {
                        selectedSentence.modify("extend", "right", "character");
                    }
                    t = end.nextElementSibling;
                    while (t != null && t.innerText != "ã€‚") {
                        selectedSentence.modify("extend", "right", "character");
                        t.style.color = currentColor;
                        t = t.nextElementSibling;
                    }
                    let range = selectedSentence.getRangeAt(0);
                    let epubcfi = new EPUBJS.EpubCFI();
                    let cfi = epubcfi.generateCfiFromRange(range, reader.book.currentChapter.cfiBase);
                    if (cfi == 'error') {
                        $('#failedMark').show();
                        setTimeout(() => {
                            $('#failedMark').hide();
                        }, 2000);
                        selectedSentence.removeAllRanges();
                        return;
                    }
                    var date = new Date();
                    $('#successedMark').show();
                    setTimeout(() => {
                        $('#successedMark').hide();
                    }, 2000);
                    fetch('/mark', { 
                        method: 'post', 
                        headers: { 
                        "Content-type": "application/x-www-form-urlencoded" 
                        }, 
                        body: "username="+username //ç”¨æˆ·å
                            +"&bookname="+bookname //ä¹¦å
                            +"&mark="+ range.toString()//æ ‡è®°å†…å®¹
                            +"&comment=å¿«é€Ÿæ ‡è®°" //æ‰¹æ³¨
                            +"&color="+currentColor //æ ‡è®°é¢œè‰²
                            +"&tag="+currentTag //æ ‡è®°ç±»å‹
                            +"&cfi="+cfi  //æ ‡è®°ä½ç½®èŒƒå›´
                            +"&time="+date.getTime() //æ ‡è®°æ—¶é—´
                    }).then((data)=>{
                        selectedSentence.removeAllRanges();
                    })
                }
                else {
                    alert('è¯·åœ¨é¡µé¢ä¸‹æ–¹é€‰æ‹©åˆé€‚çš„æ ‡ç­¾ï¼Œå†è¿›è¡Œæ ‡è®°')
                }
            };

            reader.book.on("renderer:chapterDisplayed",(chapter)=>{
                var i = document.getElementById("viewer");
                var p = i.childNodes[0].childNodes[0];
                var id = p.getAttribute('id');
                var obj=document.getElementById(id).contentWindow;
                obj.onkeydown=function(event){
                    if (event.keyCode == 38)//ä¸Š
                    {
                        fontSize = fontSize+0.1;
                        var url = window.location.href.split('#')[1];
                        var compareCFI = url.split('!')[0]+')';
                        for(var t=0;t<topic.length;t++)
                        {
                            if(compareCFI == topic[t].cfi)
                            {
                                reader.book.displayChapter(topic[t].cfi);
                            }
                        }
                    }
                    if (event.keyCode == 40)//ä¸‹
                    {
                        fontSize = fontSize-0.1;
                        var url = window.location.href.split('#')[1];
                        var compareCFI = url.split('!')[0]+')';
                        for(var t=0;t<topic.length;t++)
                        {
                            if(compareCFI == topic[t].cfi)
                            {
                                reader.book.displayChapter(topic[t].cfi);
                            }
                        }
                    }
                } 
                obj.onmousewheel=function(event){
                    if(event.shiftKey)
                    {
                        if(event.wheelDelta<0)
                        {
                            fontSize = fontSize-0.1;
                            var compareCFI = 'epubcfi('+reader.book.currentChapter.cfiBase+')';
                            for(var t=0;t<topic.length;t++)
                            {
                                if(compareCFI == topic[t].cfi)
                                {
                                    reader.book.displayChapter(topic[t].cfi);
                                }
                            }
                        }
                        else
                        {
                            fontSize = fontSize+0.1;
                            var compareCFI = 'epubcfi('+reader.book.currentChapter.cfiBase+')';
                            for(var t=0;t<topic.length;t++)
                            {
                                if(compareCFI == topic[t].cfi)
                                {
                                    reader.book.displayChapter(topic[t].cfi);
                                }
                            }
                        }
                    }
                    else
                    {
                        if(event.wheelDelta<0)
                            reader.book.nextPage();
                        else
                            reader.book.prevPage();
                    }
                    
                }
                var ifmObj=obj.document.getElementsByTagName('p');
                if(markingMode)
                {
                    for(let i=0;i<ifmObj.length;i++)
                    {
                        var para = ifmObj[i].innerText;
                        var para1 = [];
                        for(let j=0;j<para.length;j++)
                        {
                            para1.push(`<span style="font-size:${fontSize+'em'}">`+para[j]+'</span>'); //åˆ†å­—
                        }
                        ifmObj[i].innerHTML=para1.join('');
                    }
                    fetch('/getUserMarks', { 
                            method: 'post', 
                            headers: { 
                            "Content-type": "application/x-www-form-urlencoded" 
                            }, 
                            body: "bookname="+bookname
                    }).then((response) =>{
                        response.json().then((data)=>{
                            for(var i=0;i<data.length;i++)
                            { 
                                var color = data[i].color;
                                var markusername = data[i].username;
                                var comment = data[i].comment;

                                var judgeCFI = data[i].cfi.split('!')[0].substr(8);
                                if(judgeCFI == chapter.cfiBase)
                                {
                                    var epubcfi = new EPUBJS.EpubCFI();
                                    var doc = reader.book.renderer.doc;
                                    var range = epubcfi.generateRangeFromCfi(data[i].cfi, doc);
                                    if (range!=null) 
                                    {
                                        var span = range.startContainer.parentNode;
                                        var spanEnd = span;
                                        var cfiFront = data[i].cfi.split('!')[1].split(',')[0].split('/');
                                        if(cfiFront[0]=='')
                                            cfiFront = data[i].cfi.split('!')[1].split(',')[0].slice(1).split('/');
                                        var cfiEnd = data[i].cfi.split('!')[1].split(',')[1].slice(0,-1).split('/');
                                        var spanNum;
                                        if(cfiFront[1]==cfiEnd[1] || data[i].comment=='å¿«é€Ÿæ ‡è®°')
                                        {
                                            spanNum = (cfiEnd[2] - cfiFront[2]) / 2;
                                            var j=0;
                                            while(j<spanNum)
                                            {
                                                spanEnd = spanEnd.nextElementSibling;
                                                j++;
                                            }
                                            
                                        }
                                        else
                                        {
                                            while(cfiFront[1]!=cfiEnd[1]){
                                                try{
                                                    if(spanEnd.parentNode.nextElementSibling.innerText!='')
                                                    {
                                                        spanEnd = spanEnd.parentNode.nextElementSibling.firstChild;//ä¸‹ä¸€æ®µçš„é¦–èŠ‚ç‚¹
                                                    }
                                                    else
                                                    {
                                                        spanEnd = spanEnd.parentNode.nextElementSibling.nextElementSibling.firstChild;//æŸäº›epubä¹¦ä¸­å«æœ‰<p></p>ç©ºæ ‡ç­¾ï¼Œè·³è¿‡è¿™äº›ç©ºæ®µ
                                                    }
                                                    if(spanEnd.parentNode.nextElementSibling.innerText!='')
                                                        cfiFront[1] = parseInt(cfiFront[1]) + 2;
                                                    else
                                                        cfiFront[1] = parseInt(cfiFront[1]) + 4; //åŒä¸Šï¼Œç©ºPæ ‡ç­¾ä¹Ÿä¼šå ç”¨CFIçš„ä¸€ä¸ªæ®µè½ä½ç½®
                                                }
                                                catch(e){
                                                    //ä»¥é˜²æå…¶ç‰¹æ®Šçš„æ’ç‰ˆæ–¹å¼çš„ä¹¦ä¸èƒ½è§£æ
                                                }
                                            }
                                            cfiFront[2] = '2';
                                            while(cfiFront[2]!=cfiEnd[2]){
                                                spanEnd = spanEnd.nextElementSibling;//ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
                                                cfiFront[2] = parseInt(cfiFront[2]) + 2;
                                            }
                                        }
                                        
                                        if(data[i].username == username)
                                        {
                                            if(data[i].tag=='æŠ˜å ')
                                            {
                                                while(span!=spanEnd){ 
                                                    if(span.innerText!='')
                                                    {
                                                        span.style.display = 'none';
                                                        if(span.nextElementSibling!=null)
                                                        {
                                                            span = span.nextElementSibling;//è·¨SPANæ ‡ç­¾çš„æƒ…å†µ
                                                        }
                                                        else
                                                        {   
                                                            if(span.parentNode.nextElementSibling.innerText!='')
                                                                span = span.parentNode.nextElementSibling.firstChild;//è·¨Pæ ‡ç­¾çš„æƒ…å†µ
                                                            else
                                                                span = span.parentNode.nextElementSibling;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        span = span.nextElementSibling.firstChild;//æŸäº›epubä¹¦ä¸­å«æœ‰<p></p>ç©ºæ ‡ç­¾ï¼Œè·³è¿‡è¿™äº›ç©ºæ®µ
                                                    }
                                                }
                                                span.style.display = 'none';
                                            }
                                            else
                                            {
                                                Colorful(span,spanEnd,data[i].color);
                                                if(data[i].comment!=''&&data[i].comment!='å¿«é€Ÿæ ‡è®°')
                                                {
                                                    var commentSpan=document.createElement("span");
                                                    commentSpan.style.fontSize = '75%';
                                                    commentSpan.setAttribute('state','1');
                                                    commentSpan.style.cursor = 'pointer';
                                                    commentSpan.style.display = 'inline';
                                                    commentSpan.style.padding = '0.2em 0.6em 0.3em';
                                                    commentSpan.style.margin = '0.2em 0.6em 0.3em';
                                                    commentSpan.style.fontWeight = '700';
                                                    commentSpan.style.lineHeight = '1';
                                                    commentSpan.style.color = '#fff';
                                                    commentSpan.style.textAlign = 'center';
                                                    commentSpan.style.verticalAlign = 'baseline';
                                                    commentSpan.style.borderRadius = '0.25em';
                                                    commentSpan.style.lineHeight='2em';
                                                    commentSpan.style.userSelect='none';
                                                    commentSpan.style.backgroundColor = data[i].color;
                                                    clickMarkSelf(commentSpan,data[i],span,spanEnd);
                                                    if(data[i].tag=='åˆ†äº«')
                                                        commentSpan.innerHTML=data[i].tag+'ï¼š'+data[i].comment+'<span style="color:black;">(ğŸ‘ '+data[i].likes+')</span>';
                                                    else
                                                        commentSpan.innerText=data[i].tag+'ï¼š'+data[i].comment;
                                                    spanEnd.parentNode.appendChild(commentSpan);
                                                }
                                                else
                                                {
                                                    var commentSpan=document.createElement("span");
                                                    commentSpan.style.fontSize = '75%';
                                                    commentSpan.setAttribute('state','1');
                                                    commentSpan.style.cursor = 'pointer';
                                                    commentSpan.style.display = 'inline';
                                                    commentSpan.style.padding = '0.2em 0.6em 0.3em';
                                                    commentSpan.style.margin = '0.2em 0.6em 0.3em';
                                                    commentSpan.style.fontWeight = '700';
                                                    commentSpan.style.lineHeight = '1';
                                                    commentSpan.style.color = '#fff';
                                                    commentSpan.style.textAlign = 'center';
                                                    commentSpan.style.verticalAlign = 'baseline';
                                                    commentSpan.style.borderRadius = '0.25em';
                                                    commentSpan.style.lineHeight='2em';
                                                    commentSpan.style.userSelect='none';
                                                    commentSpan.style.backgroundColor = data[i].color;
                                                    clickMarkSelf(commentSpan,data[i],span,spanEnd);
                                                    if(data[i].tag=='åˆ†äº«')
                                                        commentSpan.innerHTML=data[i].tag+'<span style="color:black;">(ğŸ‘ '+data[i].likes+')</span>';
                                                    else
                                                        commentSpan.innerText = data[i].tag;
                                                    spanEnd.parentNode.appendChild(commentSpan);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            if(shareMarks == true)
                                            {
                                                if(data[i].tag=='åˆ†äº«')
                                                {
                                                    var commentSpan=document.createElement("span");
                                                    var color = data[i].color;
                                                    if(data[i].comment.length>10)
                                                        commentSpan.innerHTML='"'+data[i].username+'"çš„æ‰¹æ³¨ï¼š'+data[i].comment.substr(0,10).replace(/[\r\n]/g,"")+'...å‰©ä½™'+(data[i].comment.length-10)+'å­—'+'<span style="color:red;">(ğŸ‘ '+data[i].likes+')</span>';
                                                    else
                                                    {
                                                        if(data[i].comment=='')
                                                        {
                                                            commentSpan.innerHTML='"'+data[i].username+'"çš„æ ‡è®°'+'<span style="color:red;">(ğŸ‘ '+data[i].likes+')</span>';
                                                        }
                                                        else
                                                        {
                                                            commentSpan.innerHTML='"'+data[i].username+'"çš„æ‰¹æ³¨ï¼š'+data[i].comment.replace(/[\r\n]/g,"")+'<span style="color:red;">(ğŸ‘ '+data[i].likes+')</span>';
                                                        }
                                                    }
                                                    commentSpan.setAttribute('state','1');
                                                    commentSpan.setAttribute('title','æŸ¥çœ‹æ ‡è®°');
                                                    commentSpan.style.fontSize = '75%';
                                                    commentSpan.style.cursor = 'pointer';
                                                    commentSpan.style.display = 'inline';
                                                    commentSpan.style.padding = '0.2em 0.6em 0.3em';
                                                    commentSpan.style.margin = '0.2em 0.6em 0.3em';
                                                    commentSpan.style.fontWeight = '700';
                                                    commentSpan.style.lineHeight = '1';
                                                    commentSpan.style.color = '#fff';
                                                    commentSpan.style.textAlign = 'center';
                                                    commentSpan.style.verticalAlign = 'baseline';
                                                    commentSpan.style.borderRadius = '0.25em';
                                                    commentSpan.style.lineHeight='2em';
                                                    commentSpan.style.userSelect='none';
                                                    commentSpan.style.backgroundColor = data[i].color;
                                                    clickMark(commentSpan,data[i],span,spanEnd);
                                                    spanEnd.parentNode.appendChild(commentSpan);
                                                }
                                            }
                                        }
                                        
                                    }
                                }
                            }
                        });
                    }).catch(function(e) {
                        console.log("getUserMarks error");
                    });
                }
                else//åˆ†å¥
                {
                    for (let i = 0; i < ifmObj.length; i++) {
                        var para = ifmObj[i].innerText;
                        var para1 = [];
                        var sentence = [];
                        for (let j = 0; j < para.length; j++) {
                            if (para[j] != 'ã€‚') {
                                sentence.unshift(`<span style="cursor:pointer;font-size:${fontSize + 'em'}" onclick="window.parent.getCFI(this);">` + `${para[j]}` + '</span>');
                            }
                            else
                            {
                                sentence.unshift(`<span style="cursor:pointer;font-size:${fontSize + 'em'}">` + `${para[j]}` + '</span>');
                            }
                            if (j == para.length - 1) {
                                para1.push(sentence.reverse().join(''));
                                sentence = [];
                            }
                        }
                        ifmObj[i].innerHTML = para1.join('');
                    }
                }
            });
            reader.book.on("renderer:locationChanged",function(){
                $('#rate').text('å½“å‰ç¬¬'+reader.book.renderer.chapterPos+'é¡µï¼Œæœ¬ç« å…±'+reader.book.renderer.displayedPages+'é¡µ');
                $('#rate').css('width',`${reader.book.renderer.chapterPos/reader.book.renderer.displayedPages*100}%`);
            });
            reader.book.on('renderer:mouseup', function(event) { //ç»‘å®šé¼ æ ‡æŠ¬èµ·äº‹ä»¶ï¼Œå†åˆ¤æ–­æ˜¯å¦å­˜åœ¨é€‰ä¸­æ–‡æœ¬
                if(markingMode)
                {
                    selected = reader.book.renderer.render.window.getSelection();
                    if(selected!='' && markingMode)
                        $('#exampleModal').modal('show');
                }
            });
            var tagSelect='æ— æ ‡ç­¾';
            var color = '#ffffff';
            fetch('/getUserTags', { 
                method: 'post', 
                headers: { 
                "Content-type": "application/x-www-form-urlencoded" 
                }, 
                body: "username="+username //ç”¨æˆ·å
            }).then(
                response => response.json()
            ).then((user)=>{
                   tags = user[0].tags.split(',').slice(0,-1);
                   for(var tag=0;tag<tags.length;tag++)
                   {
                        $('#tags').prepend(`<span class="label label-primary" style="cursor:pointer;background-color:#${tags[tag].split('#')[1]}" onclick='tagsSelect("${tags[tag].split('#')[0]}","#${tags[tag].split('#')[1]}");' id=${tags[tag]}>${tags[tag].split('#')[0]}</span> `);
                   }
            }).catch(function(e) {
                console.log(e);
            });

            function tagsSelect(tag,col){
                tagSelect = tag;
                $('#message-text').attr('disabled',false);
                $('#commentParagraph').css('color',col);
                color = col;
            }
            
            $('#tagNameInput').hide(); 
            $('#color').hide();
            $('#submitAddTag').hide(); 
            $('#closeAddTag').hide();
            $('#closeRemove').hide();
            $('#closeRemove').click(()=>{
                $('#addTag').show();
                $('#removeTag').show();
                $('#closeRemove').hide();
                $('.glyphicon-remove').remove();
            })
            $('#closeAddTag').click(()=>{
                $('#tagNameInput').val('').hide();
                $('#color').hide();
                $('#submitAddTag').hide();
                $('#closeAddTag').hide();
                $('#addTag').show();
                $('#removeTag').show();
            })
            $('#addTag').click(()=>{
                $('#addTag').hide();
                $('#removeTag').hide();
                $('#tagNameInput').show();
                $('#color').show();
                $('#color').val('#5bc0de');
                $('#submitAddTag').show(); 
                $('#closeAddTag').show();
            })
            $('#removeTag').click(()=>{
                $('#addTag').hide();
                $('#tagNameInput').hide();
                $('#color').hide();
                $('#submitAddTag').hide(); 
                $('#closeAddTag').hide();
                $('#removeTag').hide();
                $('#closeRemove').show();
                fetch('/getUserTags', { 
                    method: 'post', 
                    headers: { 
                    "Content-type": "application/x-www-form-urlencoded" 
                    }, 
                    body: "username="+username //ç”¨æˆ·å
                }).then(
                    response => response.json()
                ).then((user)=>{
                    tagsForRemove = user[0].tags.split(',').slice(0,-1);
                    for(let i=0;i<$('#tags').children().length;i++)
                    {
                        var iconRemove = document.createElement('span');
                        iconRemove.setAttribute('class','glyphicon glyphicon-remove');
                        iconRemove.style.fontSize = '1.2em';
                        iconRemove.style.position = 'relative';
                        iconRemove.style.left = '5px';
                        iconRemove.onclick=function(){
                            var index = tagsForRemove.indexOf($('#tags').children()[i].getAttribute('id'));
                            if(index>=0 && tagsForRemove.length>=3)
                            {
                                tagsForRemove.splice(index,1);
                                var newtags = tagsForRemove.join(',')+',';
                                $('#tags').children()[i].style.display = 'none';
                                fetch('/removeUserTag', { 
                                    method: 'post', 
                                    headers: { 
                                    "Content-type": "application/x-www-form-urlencoded" 
                                    }, 
                                    body:"username="+username+"&tags="+newtags
                                })
                            }
                            else
                            {
                                alert('è¯·æœ€å°‘ä¿ç•™2ä¸ªæ ‡ç­¾');
                            }
                        }
                        $('#tags').children()[i].append(iconRemove);
                    }
                }).catch(function(e) {
                    console.log(e);
                });
            })
            $('#submitAddTag').click(()=>{
                if($('#tagNameInput').val()!='')
                {
                    if($('#tagNameInput').val().indexOf(' ')>=0)
                    {
                        $('#tagNameInput').val('');
                        $('#tagNameInput').attr('placeholder','è¯·åˆ é™¤ç©ºæ ¼~');
                        $('#tagNameInput').focus();
                    }
                    else
                    {
                        fetch('/getUserTags', { 
                            method: 'post', 
                            headers: { 
                            "Content-type": "application/x-www-form-urlencoded" 
                            }, 
                            body: "username="+username //ç”¨æˆ·å
                        }).then(
                            response => response.json()
                        ).then((user)=>{
                            tags = user[0].tags.split(',').slice(0,-1);
                            tagSelect = $('#tagNameInput').val();
                            color = $('#color').val();
                            let amateurishMan = 0;
                            for(let i=0;i<tags.length;i++)
                            {
                                let tagName = tags[i].split('#')[0];
                                if(tagName == tagSelect)
                                    amateurishMan = 1;
                            }
                            if(amateurishMan == 1)
                            {
                                alert('è¿™ä¸ªæ ‡ç­¾å·²ç»å­˜åœ¨äº†ï¼Œå¦‚æ›´æ¢é¢œè‰²è¯·åˆ é™¤åŸæ ‡ç­¾åå†æ–°å»º');
                            }
                            else
                            {
                                $('#tags').prepend(`<span class="label label-primary" onclick='tagsSelect("${tagSelect}","${color}");' id="${tagSelect}${color}" style="cursor:pointer;background-color:${color}">${tagSelect}</span> `);
                                $('#tagNameInput').val('').hide();
                                $('#color').hide();
                                $('#submitAddTag').hide();
                                $('#closeAddTag').hide();
                                $('#addTag').show();
                                $('#removeTag').show();
                                var newtags = tags.join(',')+','+tagSelect+color+',';
                                fetch('/saveUserTags', { 
                                    method: 'post', 
                                    headers: { 
                                    "Content-type": "application/x-www-form-urlencoded" 
                                    }, 
                                    body:"username="+username+"&tag="+newtags
                                })
                            }
                        }).catch(function(e) {
                            console.log(e);
                        });
                    }
                }
                else
                {
                    $('#tagNameInput').focus();
                }
            })
            $('#exampleModal').on('show.bs.modal', (event) =>{
                if(selected=='')
                {
                    $('#commentParagraph').text('æœªé€‰ä¸­ä»»ä½•å†…å®¹');
                    $('#tagFrame').css('display','none');
                    $('#message-text').css('display','none');
                    $('#commentFinish').css('display','none');
                }
                else
                {
                    document.onkeydown=null;
                    tagSelect='æ— æ ‡ç­¾';
                    color = '#ffffff';
                    $('#message-text').attr('disabled',true);
                    $('#tagFrame').css('display','');
                    $('#message-text').css('display','');
                    $('#message-text').text('');
                    $('#commentFinish').css('display','');
                    $('#commentParagraph').text(selected);
                    $('#message-text').keyup((e)=>{
                        $('#commentParagraph').text(selected+'ã€'+tagSelect+'ï¼š'+$('#message-text').val()+'ã€‘');
                    })
                    if(selected.toString().indexOf('ğŸ‘')>=0)
                    {
                        $('#message-text').attr('placeholder','æ³¨æ„ï¼šæ‚¨é€‰æ‹©çš„æ–‡æœ¬ä¸­å«æœ‰å…¶ä»–è¯»è€…çš„æ ‡è®°ã€‚');
                    }
                    else
                    {
                        $('#message-text').attr('placeholder','æç¤ºï¼šåœ¨ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ ‡ç­¾ï¼Œå¹¶åœ¨æ­¤ä½œä¸€äº›æ‰¹æ³¨ã€‚');
                    }
                    $('#commentFinish').click(()=>{
                        try{
                            var range = selected.getRangeAt(0);
                            var span = range.startContainer.parentNode;
                            var epubcfi = new EPUBJS.EpubCFI();
                            var chapter = reader.book.currentChapter;
                            var cfiBase = chapter.cfiBase;
                            var cfi = epubcfi.generateCfiFromRange(range, cfiBase);//é€‰ä¸­ç»“æŸçš„ä½ç½®
                            var myDate = new Date();
                            if(span.parentNode.nodeName=='P' && tagSelect!='æ— æ ‡ç­¾')
                            {
                                span = Colorful(span,range.endContainer.parentNode,color);
                                var commentSpan=document.createElement("span");
                                if($('#message-text').val()!='')
                                {
                                    var commentText=document.createTextNode(tagSelect+'ï¼š'+$('#message-text').val());
                                }
                                else
                                {
                                    var commentText=document.createTextNode(tagSelect);
                                }
                                commentSpan.style.fontSize = '75%';
                                commentSpan.style.cursor = 'pointer';
                                commentSpan.style.display = 'inline';
                                commentSpan.style.padding = '0.2em 0.6em 0.3em';
                                commentSpan.style.margin = '0.2em 0.6em 0.3em';
                                commentSpan.style.fontWeight = '700';
                                commentSpan.style.lineHeight = '1';
                                commentSpan.style.color = '#fff';
                                commentSpan.style.textAlign = 'center';
                                commentSpan.style.verticalAlign = 'baseline';
                                commentSpan.style.borderRadius = '0.25em';
                                commentSpan.style.backgroundColor = color;
                                commentSpan.style.lineHeight='2em';
                                commentSpan.style.userSelect='none';
                                commentSpan.appendChild(commentText);
                                span.parentNode.appendChild(commentSpan);
                                $('#successedMark').show();
                                setTimeout(() => {
                                    $('#successedMark').hide();
                                }, 2000);
                                fetch('/mark', { 
                                    method: 'post', 
                                    headers: { 
                                    "Content-type": "application/x-www-form-urlencoded" 
                                    }, 
                                    body: "username="+username //ç”¨æˆ·å
                                        +"&bookname="+bookname //ä¹¦å
                                        +"&mark="+selected.toString() //æ ‡è®°å†…å®¹
                                        +"&comment="+$('#message-text').val() //æ‰¹æ³¨
                                        +"&color="+color //æ ‡è®°é¢œè‰²
                                        +"&tag="+tagSelect //æ ‡è®°ç±»å‹
                                        +"&cfi="+cfi  //æ ‡è®°ä½ç½®èŒƒå›´
                                        +"&time="+myDate.getTime() //æ ‡è®°æ—¶é—´
                                })
                            }
                            else
                            {
                                $('#failedMarkSelect').show();
                                setTimeout(() => {
                                    $('#failedMarkSelect').hide();
                                }, 2000);
                            }
                            color = '#ffffff';
                            selected.removeAllRanges();
                            $('#commentParagraph').css('background-color',color);
                            $('#message-text').val('');
                            $('#exampleModal').modal('hide');
                        }
                        catch(err)
                        {
                        }
                    })
                }
            })
      </script>
    </body>
</html>



